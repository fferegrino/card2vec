import json
import random
from pathlib import Path
from unittest.mock import ANY, patch

import numpy as np
import pytest

from card2vec.feature_extraction.examples import (
    generate_all_examples,
    generate_batches,
    get_examples_for_deck,
    get_negative_samples,
    get_positive_samples,
)


@pytest.fixture
def seed():
    random.seed(42)
    np.random.seed(42)
    yield


@pytest.fixture()
def all_cards():
    return np.arange(0, 1000)


@pytest.mark.parametrize(
    ["position", "deck", "window", "expected"],
    [
        # fmt: off
    (
            0,
            np.arange(10, 20),
            2,
            np.array([
                [ 10,  18],
                [ 10,  19],
                [ 10,  11],
                [ 10,  12]
            ])

    ),
    (
            2,
            np.array([5, 4, 7, 7, 7]),
            2,
            np.array([
                [7, 5],
                [7, 4],
                [7, 7],
                [7, 7],
            ])

    ),
    (
            0,
            np.arange(10, 20),
            2,
            np.array([
                [ 10,  18],
                [ 10,  19],
                [ 10,  11],
                [ 10,  12]
            ])
    ),
    (
            5,
            np.arange(1, 11),
            4,
            np.array([
                [ 6,  2],
                [ 6,  3],
                [ 6,  4],
                [ 6,  5],
                [ 6,  7],
                [ 6,  8],
                [ 6,  9],
                [ 6,  10]
            ])
    ),
    (
            9,
            np.arange(10, 20),
            2,
            np.array([
                [ 19,  17],
                [ 19,  18],
                [ 19,  10],
                [ 19,  11]
            ])
    ),
    (
            1,
            np.array([1,2,3]),
            2,
            np.array([
                [ 2,  3],
                [ 2,  1],
                [ 2,  3],
                [ 2,  1]
            ])
    ),
    (
            1,
            np.array([1,2,3]),
            4,
            np.array([
                [ 2,  1],
                [ 2,  2],
                [ 2,  3],
                [ 2,  1],
                [ 2,  3],
                [ 2,  1],
                [ 2,  2],
                [ 2,  3]
            ])
    )
        # fmt: on
    ],
)
def test_get_positive_samples(position, deck, window, expected):
    actual = get_positive_samples(position, deck, window)
    np.testing.assert_array_equal(actual, expected)


@pytest.mark.parametrize(
    ["position", "n_negatives", "expected"],
    [
        # fmt: off
    (
        0,
        10,
        np.array([
            [0, 102],
            [0, 435],
            [0, 860],
            [0, 270],
            [0, 106],
            [0, 71],
            [0, 700],
            [0, 20],
            [0, 614],
            [0, 121]
          ])
    ),
    (
        0,
        2,
        np.array([
            [0, 102],
            [0, 435]
          ])
    ),
        # fmt: on
    ],
)
def test_get_negative_samples(seed, all_cards, position, n_negatives, expected):
    deck = np.arange(0, 10)
    actual = get_negative_samples(position, deck, n_negatives, all_cards)
    np.testing.assert_array_equal(actual, expected)


@pytest.mark.parametrize(
    [
        "n_negatives",
        "window_size",
        "shuffles",
        "positive_expected",
        "negative_expected",
    ],
    [
        (
            2,
            5,
            1,
            np.array(
                [
                    [0, 8],
                    [0, 9],
                    [0, 1],
                    [0, 2],
                    [1, 9],
                    [1, 0],
                    [1, 2],
                    [1, 3],
                    [2, 0],
                    [2, 1],
                    [2, 3],
                    [2, 4],
                    [3, 1],
                    [3, 2],
                    [3, 4],
                    [3, 5],
                    [4, 2],
                    [4, 3],
                    [4, 5],
                    [4, 6],
                    [5, 3],
                    [5, 4],
                    [5, 6],
                    [5, 7],
                    [6, 4],
                    [6, 5],
                    [6, 7],
                    [6, 8],
                    [7, 5],
                    [7, 6],
                    [7, 8],
                    [7, 9],
                    [8, 6],
                    [8, 7],
                    [8, 9],
                    [8, 0],
                    [9, 7],
                    [9, 8],
                    [9, 0],
                    [9, 1],
                ]
            ),
            np.array(
                [
                    [0, 102],
                    [0, 435],
                    [1, 860],
                    [1, 270],
                    [2, 106],
                    [2, 71],
                    [3, 700],
                    [3, 20],
                    [4, 614],
                    [4, 121],
                    [5, 466],
                    [5, 214],
                    [6, 330],
                    [6, 458],
                    [7, 87],
                    [7, 372],
                    [8, 99],
                    [8, 871],
                    [9, 663],
                    [9, 130],
                ]
            ),
        ),
        (
            10,
            15,
            4,
            np.array(
                [
                    [0, 3],
                    [0, 4],
                    [0, 5],
                    [0, 6],
                    [0, 7],
                    [0, 8],
                    [0, 9],
                    [0, 1],
                    [0, 2],
                    [0, 3],
                    [0, 4],
                    [0, 5],
                    [0, 6],
                    [0, 7],
                    [1, 4],
                    [1, 5],
                    [1, 6],
                    [1, 7],
                    [1, 8],
                    [1, 9],
                    [1, 0],
                    [1, 2],
                    [1, 3],
                    [1, 4],
                    [1, 5],
                    [1, 6],
                    [1, 7],
                    [1, 8],
                    [2, 5],
                    [2, 6],
                    [2, 7],
                    [2, 8],
                    [2, 9],
                    [2, 0],
                    [2, 1],
                    [2, 3],
                    [2, 4],
                    [2, 5],
                    [2, 6],
                    [2, 7],
                    [2, 8],
                    [2, 9],
                    [3, 6],
                    [3, 7],
                    [3, 8],
                    [3, 9],
                    [3, 0],
                    [3, 1],
                    [3, 2],
                    [3, 4],
                    [3, 5],
                    [3, 6],
                    [3, 7],
                    [3, 8],
                    [3, 9],
                    [3, 0],
                    [4, 7],
                    [4, 8],
                    [4, 9],
                    [4, 0],
                    [4, 1],
                    [4, 2],
                    [4, 3],
                    [4, 5],
                    [4, 6],
                    [4, 7],
                    [4, 8],
                    [4, 9],
                    [4, 0],
                    [4, 1],
                    [5, 8],
                    [5, 9],
                    [5, 0],
                    [5, 1],
                    [5, 2],
                    [5, 3],
                    [5, 4],
                    [5, 6],
                    [5, 7],
                    [5, 8],
                    [5, 9],
                    [5, 0],
                    [5, 1],
                    [5, 2],
                    [6, 9],
                    [6, 0],
                    [6, 1],
                    [6, 2],
                    [6, 3],
                    [6, 4],
                    [6, 5],
                    [6, 7],
                    [6, 8],
                    [6, 9],
                    [6, 0],
                    [6, 1],
                    [6, 2],
                    [6, 3],
                    [7, 0],
                    [7, 1],
                    [7, 2],
                    [7, 3],
                    [7, 4],
                    [7, 5],
                    [7, 6],
                    [7, 8],
                    [7, 9],
                    [7, 0],
                    [7, 1],
                    [7, 2],
                    [7, 3],
                    [7, 4],
                    [8, 1],
                    [8, 2],
                    [8, 3],
                    [8, 4],
                    [8, 5],
                    [8, 6],
                    [8, 7],
                    [8, 9],
                    [8, 0],
                    [8, 1],
                    [8, 2],
                    [8, 3],
                    [8, 4],
                    [8, 5],
                    [9, 2],
                    [9, 3],
                    [9, 4],
                    [9, 5],
                    [9, 6],
                    [9, 7],
                    [9, 8],
                    [9, 0],
                    [9, 1],
                    [9, 2],
                    [9, 3],
                    [9, 4],
                    [9, 5],
                    [9, 6],
                    [4, 0],
                    [4, 8],
                    [4, 7],
                    [4, 6],
                    [4, 5],
                    [4, 3],
                    [4, 1],
                    [4, 2],
                    [4, 9],
                    [4, 0],
                    [4, 8],
                    [4, 7],
                    [4, 6],
                    [4, 5],
                    [2, 8],
                    [2, 7],
                    [2, 6],
                    [2, 5],
                    [2, 3],
                    [2, 1],
                    [2, 4],
                    [2, 9],
                    [2, 0],
                    [2, 8],
                    [2, 7],
                    [2, 6],
                    [2, 5],
                    [2, 3],
                    [9, 7],
                    [9, 6],
                    [9, 5],
                    [9, 3],
                    [9, 1],
                    [9, 4],
                    [9, 2],
                    [9, 0],
                    [9, 8],
                    [9, 7],
                    [9, 6],
                    [9, 5],
                    [9, 3],
                    [9, 1],
                    [0, 6],
                    [0, 5],
                    [0, 3],
                    [0, 1],
                    [0, 4],
                    [0, 2],
                    [0, 9],
                    [0, 8],
                    [0, 7],
                    [0, 6],
                    [0, 5],
                    [0, 3],
                    [0, 1],
                    [0, 4],
                    [8, 5],
                    [8, 3],
                    [8, 1],
                    [8, 4],
                    [8, 2],
                    [8, 9],
                    [8, 0],
                    [8, 7],
                    [8, 6],
                    [8, 5],
                    [8, 3],
                    [8, 1],
                    [8, 4],
                    [8, 2],
                    [7, 3],
                    [7, 1],
                    [7, 4],
                    [7, 2],
                    [7, 9],
                    [7, 0],
                    [7, 8],
                    [7, 6],
                    [7, 5],
                    [7, 3],
                    [7, 1],
                    [7, 4],
                    [7, 2],
                    [7, 9],
                    [6, 1],
                    [6, 4],
                    [6, 2],
                    [6, 9],
                    [6, 0],
                    [6, 8],
                    [6, 7],
                    [6, 5],
                    [6, 3],
                    [6, 1],
                    [6, 4],
                    [6, 2],
                    [6, 9],
                    [6, 0],
                    [5, 4],
                    [5, 2],
                    [5, 9],
                    [5, 0],
                    [5, 8],
                    [5, 7],
                    [5, 6],
                    [5, 3],
                    [5, 1],
                    [5, 4],
                    [5, 2],
                    [5, 9],
                    [5, 0],
                    [5, 8],
                    [3, 2],
                    [3, 9],
                    [3, 0],
                    [3, 8],
                    [3, 7],
                    [3, 6],
                    [3, 5],
                    [3, 1],
                    [3, 4],
                    [3, 2],
                    [3, 9],
                    [3, 0],
                    [3, 8],
                    [3, 7],
                    [1, 9],
                    [1, 0],
                    [1, 8],
                    [1, 7],
                    [1, 6],
                    [1, 5],
                    [1, 3],
                    [1, 4],
                    [1, 2],
                    [1, 9],
                    [1, 0],
                    [1, 8],
                    [1, 7],
                    [1, 6],
                    [0, 6],
                    [0, 4],
                    [0, 1],
                    [0, 8],
                    [0, 3],
                    [0, 2],
                    [0, 7],
                    [0, 9],
                    [0, 5],
                    [0, 6],
                    [0, 4],
                    [0, 1],
                    [0, 8],
                    [0, 3],
                    [9, 4],
                    [9, 1],
                    [9, 8],
                    [9, 3],
                    [9, 2],
                    [9, 7],
                    [9, 0],
                    [9, 5],
                    [9, 6],
                    [9, 4],
                    [9, 1],
                    [9, 8],
                    [9, 3],
                    [9, 2],
                    [5, 1],
                    [5, 8],
                    [5, 3],
                    [5, 2],
                    [5, 7],
                    [5, 0],
                    [5, 9],
                    [5, 6],
                    [5, 4],
                    [5, 1],
                    [5, 8],
                    [5, 3],
                    [5, 2],
                    [5, 7],
                    [6, 8],
                    [6, 3],
                    [6, 2],
                    [6, 7],
                    [6, 0],
                    [6, 9],
                    [6, 5],
                    [6, 4],
                    [6, 1],
                    [6, 8],
                    [6, 3],
                    [6, 2],
                    [6, 7],
                    [6, 0],
                    [4, 3],
                    [4, 2],
                    [4, 7],
                    [4, 0],
                    [4, 9],
                    [4, 5],
                    [4, 6],
                    [4, 1],
                    [4, 8],
                    [4, 3],
                    [4, 2],
                    [4, 7],
                    [4, 0],
                    [4, 9],
                    [1, 2],
                    [1, 7],
                    [1, 0],
                    [1, 9],
                    [1, 5],
                    [1, 6],
                    [1, 4],
                    [1, 8],
                    [1, 3],
                    [1, 2],
                    [1, 7],
                    [1, 0],
                    [1, 9],
                    [1, 5],
                    [8, 7],
                    [8, 0],
                    [8, 9],
                    [8, 5],
                    [8, 6],
                    [8, 4],
                    [8, 1],
                    [8, 3],
                    [8, 2],
                    [8, 7],
                    [8, 0],
                    [8, 9],
                    [8, 5],
                    [8, 6],
                    [3, 0],
                    [3, 9],
                    [3, 5],
                    [3, 6],
                    [3, 4],
                    [3, 1],
                    [3, 8],
                    [3, 2],
                    [3, 7],
                    [3, 0],
                    [3, 9],
                    [3, 5],
                    [3, 6],
                    [3, 4],
                    [2, 9],
                    [2, 5],
                    [2, 6],
                    [2, 4],
                    [2, 1],
                    [2, 8],
                    [2, 3],
                    [2, 7],
                    [2, 0],
                    [2, 9],
                    [2, 5],
                    [2, 6],
                    [2, 4],
                    [2, 1],
                    [7, 5],
                    [7, 6],
                    [7, 4],
                    [7, 1],
                    [7, 8],
                    [7, 3],
                    [7, 2],
                    [7, 0],
                    [7, 9],
                    [7, 5],
                    [7, 6],
                    [7, 4],
                    [7, 1],
                    [7, 8],
                    [4, 7],
                    [4, 8],
                    [4, 2],
                    [4, 3],
                    [4, 6],
                    [4, 5],
                    [4, 1],
                    [4, 0],
                    [4, 9],
                    [4, 7],
                    [4, 8],
                    [4, 2],
                    [4, 3],
                    [4, 6],
                    [0, 8],
                    [0, 2],
                    [0, 3],
                    [0, 6],
                    [0, 5],
                    [0, 1],
                    [0, 4],
                    [0, 9],
                    [0, 7],
                    [0, 8],
                    [0, 2],
                    [0, 3],
                    [0, 6],
                    [0, 5],
                    [9, 2],
                    [9, 3],
                    [9, 6],
                    [9, 5],
                    [9, 1],
                    [9, 4],
                    [9, 0],
                    [9, 7],
                    [9, 8],
                    [9, 2],
                    [9, 3],
                    [9, 6],
                    [9, 5],
                    [9, 1],
                    [7, 3],
                    [7, 6],
                    [7, 5],
                    [7, 1],
                    [7, 4],
                    [7, 0],
                    [7, 9],
                    [7, 8],
                    [7, 2],
                    [7, 3],
                    [7, 6],
                    [7, 5],
                    [7, 1],
                    [7, 4],
                    [8, 6],
                    [8, 5],
                    [8, 1],
                    [8, 4],
                    [8, 0],
                    [8, 9],
                    [8, 7],
                    [8, 2],
                    [8, 3],
                    [8, 6],
                    [8, 5],
                    [8, 1],
                    [8, 4],
                    [8, 0],
                    [2, 5],
                    [2, 1],
                    [2, 4],
                    [2, 0],
                    [2, 9],
                    [2, 7],
                    [2, 8],
                    [2, 3],
                    [2, 6],
                    [2, 5],
                    [2, 1],
                    [2, 4],
                    [2, 0],
                    [2, 9],
                    [3, 1],
                    [3, 4],
                    [3, 0],
                    [3, 9],
                    [3, 7],
                    [3, 8],
                    [3, 2],
                    [3, 6],
                    [3, 5],
                    [3, 1],
                    [3, 4],
                    [3, 0],
                    [3, 9],
                    [3, 7],
                    [6, 4],
                    [6, 0],
                    [6, 9],
                    [6, 7],
                    [6, 8],
                    [6, 2],
                    [6, 3],
                    [6, 5],
                    [6, 1],
                    [6, 4],
                    [6, 0],
                    [6, 9],
                    [6, 7],
                    [6, 8],
                    [5, 0],
                    [5, 9],
                    [5, 7],
                    [5, 8],
                    [5, 2],
                    [5, 3],
                    [5, 6],
                    [5, 1],
                    [5, 4],
                    [5, 0],
                    [5, 9],
                    [5, 7],
                    [5, 8],
                    [5, 2],
                    [1, 9],
                    [1, 7],
                    [1, 8],
                    [1, 2],
                    [1, 3],
                    [1, 6],
                    [1, 5],
                    [1, 4],
                    [1, 0],
                    [1, 9],
                    [1, 7],
                    [1, 8],
                    [1, 2],
                    [1, 3],
                ]
            ),
            np.array(
                [
                    [0, 102],
                    [0, 435],
                    [0, 860],
                    [0, 270],
                    [0, 106],
                    [0, 71],
                    [0, 700],
                    [0, 20],
                    [0, 614],
                    [0, 121],
                    [1, 466],
                    [1, 214],
                    [1, 330],
                    [1, 458],
                    [1, 87],
                    [1, 372],
                    [1, 99],
                    [1, 871],
                    [1, 663],
                    [1, 130],
                    [2, 661],
                    [2, 308],
                    [2, 769],
                    [2, 343],
                    [2, 491],
                    [2, 413],
                    [2, 805],
                    [2, 385],
                    [2, 191],
                    [2, 955],
                    [3, 276],
                    [3, 160],
                    [3, 459],
                    [3, 313],
                    [3, 21],
                    [3, 252],
                    [3, 747],
                    [3, 856],
                    [3, 560],
                    [3, 474],
                    [4, 58],
                    [4, 510],
                    [4, 681],
                    [4, 475],
                    [4, 699],
                    [4, 975],
                    [4, 782],
                    [4, 189],
                    [4, 957],
                    [4, 686],
                    [5, 957],
                    [5, 562],
                    [5, 875],
                    [5, 566],
                    [5, 243],
                    [5, 831],
                    [5, 504],
                    [5, 130],
                    [5, 484],
                    [5, 818],
                    [6, 646],
                    [6, 20],
                    [6, 840],
                    [6, 166],
                    [6, 273],
                    [6, 387],
                    [6, 600],
                    [6, 315],
                    [6, 13],
                    [6, 241],
                    [7, 776],
                    [7, 345],
                    [7, 564],
                    [7, 897],
                    [7, 339],
                    [7, 91],
                    [7, 366],
                    [7, 955],
                    [7, 454],
                    [7, 427],
                    [8, 508],
                    [8, 775],
                    [8, 942],
                    [8, 34],
                    [8, 205],
                    [8, 80],
                    [8, 931],
                    [8, 561],
                    [8, 871],
                    [8, 387],
                    [9, 1],
                    [9, 389],
                    [9, 565],
                    [9, 105],
                    [9, 771],
                    [9, 821],
                    [9, 476],
                    [9, 702],
                    [9, 401],
                    [9, 729],
                    [4, 724],
                    [4, 719],
                    [4, 748],
                    [4, 337],
                    [4, 878],
                    [4, 52],
                    [4, 791],
                    [4, 921],
                    [4, 216],
                    [4, 763],
                    [2, 187],
                    [2, 379],
                    [2, 492],
                    [2, 40],
                    [2, 156],
                    [2, 14],
                    [2, 812],
                    [2, 64],
                    [2, 856],
                    [2, 838],
                    [9, 520],
                    [9, 343],
                    [9, 128],
                    [9, 647],
                    [9, 471],
                    [9, 62],
                    [9, 138],
                    [9, 498],
                    [9, 592],
                    [9, 391],
                    [0, 674],
                    [0, 418],
                    [0, 288],
                    [0, 378],
                    [0, 772],
                    [0, 489],
                    [0, 230],
                    [0, 40],
                    [0, 27],
                    [0, 134],
                    [8, 200],
                    [8, 839],
                    [8, 779],
                    [8, 929],
                    [8, 32],
                    [8, 47],
                    [8, 502],
                    [8, 406],
                    [8, 573],
                    [8, 727],
                    [7, 804],
                    [7, 98],
                    [7, 683],
                    [7, 871],
                    [7, 725],
                    [7, 986],
                    [7, 546],
                    [7, 960],
                    [7, 738],
                    [7, 612],
                    [6, 942],
                    [6, 461],
                    [6, 642],
                    [6, 768],
                    [6, 4],
                    [6, 217],
                    [6, 502],
                    [6, 766],
                    [6, 397],
                    [6, 870],
                    [5, 794],
                    [5, 392],
                    [5, 206],
                    [5, 14],
                    [5, 857],
                    [5, 553],
                    [5, 891],
                    [5, 460],
                    [5, 690],
                    [5, 574],
                    [3, 863],
                    [3, 742],
                    [3, 240],
                    [3, 563],
                    [3, 95],
                    [3, 899],
                    [3, 733],
                    [3, 484],
                    [3, 406],
                    [3, 230],
                    [1, 748],
                    [1, 654],
                    [1, 170],
                    [1, 540],
                    [1, 35],
                    [1, 524],
                    [1, 159],
                    [1, 838],
                    [1, 698],
                    [1, 242],
                    [0, 27],
                    [0, 619],
                    [0, 555],
                    [0, 339],
                    [0, 797],
                    [0, 957],
                    [0, 330],
                    [0, 639],
                    [0, 505],
                    [0, 347],
                    [9, 472],
                    [9, 230],
                    [9, 189],
                    [9, 224],
                    [9, 384],
                    [9, 376],
                    [9, 282],
                    [9, 957],
                    [9, 632],
                    [9, 627],
                    [5, 972],
                    [5, 744],
                    [5, 258],
                    [5, 358],
                    [5, 709],
                    [5, 455],
                    [5, 410],
                    [5, 648],
                    [5, 317],
                    [5, 676],
                    [6, 224],
                    [6, 818],
                    [6, 233],
                    [6, 683],
                    [6, 663],
                    [6, 974],
                    [6, 826],
                    [6, 373],
                    [6, 671],
                    [6, 607],
                    [4, 471],
                    [4, 232],
                    [4, 691],
                    [4, 112],
                    [4, 829],
                    [4, 496],
                    [4, 441],
                    [4, 563],
                    [4, 267],
                    [4, 509],
                    [1, 806],
                    [1, 385],
                    [1, 386],
                    [1, 112],
                    [1, 612],
                    [1, 624],
                    [1, 951],
                    [1, 80],
                    [1, 698],
                    [1, 112],
                    [8, 1],
                    [8, 641],
                    [8, 219],
                    [8, 565],
                    [8, 854],
                    [8, 996],
                    [8, 735],
                    [8, 224],
                    [8, 384],
                    [8, 402],
                    [3, 637],
                    [3, 129],
                    [3, 52],
                    [3, 683],
                    [3, 729],
                    [3, 671],
                    [3, 709],
                    [3, 415],
                    [3, 246],
                    [3, 835],
                    [2, 438],
                    [2, 202],
                    [2, 183],
                    [2, 122],
                    [2, 400],
                    [2, 766],
                    [2, 293],
                    [2, 279],
                    [2, 836],
                    [2, 883],
                    [7, 609],
                    [7, 197],
                    [7, 981],
                    [7, 906],
                    [7, 510],
                    [7, 751],
                    [7, 143],
                    [7, 608],
                    [7, 200],
                    [7, 123],
                    [4, 510],
                    [4, 146],
                    [4, 147],
                    [4, 863],
                    [4, 710],
                    [4, 819],
                    [4, 488],
                    [4, 928],
                    [4, 935],
                    [4, 639],
                    [0, 550],
                    [0, 337],
                    [0, 871],
                    [0, 640],
                    [0, 778],
                    [0, 987],
                    [0, 952],
                    [0, 472],
                    [0, 945],
                    [0, 150],
                    [9, 414],
                    [9, 989],
                    [9, 297],
                    [9, 610],
                    [9, 262],
                    [9, 763],
                    [9, 143],
                    [9, 345],
                    [9, 623],
                    [9, 571],
                    [7, 880],
                    [7, 1],
                    [7, 896],
                    [7, 303],
                    [7, 253],
                    [7, 651],
                    [7, 452],
                    [7, 36],
                    [7, 159],
                    [7, 8],
                    [8, 232],
                    [8, 98],
                    [8, 658],
                    [8, 815],
                    [8, 207],
                    [8, 130],
                    [8, 403],
                    [8, 151],
                    [8, 53],
                    [8, 119],
                    [2, 672],
                    [2, 919],
                    [2, 627],
                    [2, 586],
                    [2, 624],
                    [2, 967],
                    [2, 419],
                    [2, 421],
                    [2, 103],
                    [2, 851],
                    [3, 253],
                    [3, 226],
                    [3, 111],
                    [3, 509],
                    [3, 472],
                    [3, 98],
                    [3, 152],
                    [3, 860],
                    [3, 913],
                    [3, 895],
                    [6, 877],
                    [6, 337],
                    [6, 705],
                    [6, 821],
                    [6, 162],
                    [6, 719],
                    [6, 956],
                    [6, 680],
                    [6, 995],
                    [6, 160],
                    [5, 579],
                    [5, 800],
                    [5, 397],
                    [5, 276],
                    [5, 815],
                    [5, 915],
                    [5, 503],
                    [5, 895],
                    [5, 391],
                    [5, 134],
                    [1, 194],
                    [1, 400],
                    [1, 639],
                    [1, 32],
                    [1, 687],
                    [1, 459],
                    [1, 954],
                    [1, 882],
                    [1, 469],
                    [1, 374],
                ]
            ),
        ),
    ],
)
def test_get_examples_for_deck(
    seed,
    all_cards,
    n_negatives,
    window_size,
    shuffles,
    positive_expected,
    negative_expected,
):
    deck_size = 10
    deck = np.arange(0, deck_size)

    actual_positives, actual_negatives = get_examples_for_deck(
        deck, window_size, n_negatives, shuffles, all_cards
    )
    np.testing.assert_array_equal(positive_expected, actual_positives)
    np.testing.assert_array_equal(negative_expected, actual_negatives)


@pytest.mark.parametrize(
    [
        "n_negatives",
        "window_size",
        "shuffles",
        "expected_positive",
        "expected_negative",
    ],
    [
        (
            2,
            5,
            1,
            np.array(
                [
                    [1, 3],
                    [1, 4],
                    [1, 3],
                    [1, 4],
                    [3, 4],
                    [3, 1],
                    [3, 4],
                    [3, 1],
                    [4, 1],
                    [4, 3],
                    [4, 1],
                    [4, 3],
                    [0, 2],
                    [0, 5],
                    [0, 2],
                    [0, 5],
                    [2, 5],
                    [2, 0],
                    [2, 5],
                    [2, 0],
                    [5, 0],
                    [5, 2],
                    [5, 0],
                    [5, 2],
                    [7, 0],
                    [7, 7],
                    [7, 0],
                    [7, 7],
                    [0, 7],
                    [0, 7],
                    [0, 7],
                    [0, 7],
                    [7, 7],
                    [7, 0],
                    [7, 7],
                    [7, 0],
                    [5, 7],
                    [5, 7],
                    [5, 4],
                    [5, 7],
                    [4, 7],
                    [4, 5],
                    [4, 7],
                    [4, 7],
                    [7, 5],
                    [7, 4],
                    [7, 7],
                    [7, 7],
                    [7, 4],
                    [7, 7],
                    [7, 7],
                    [7, 5],
                    [7, 7],
                    [7, 7],
                    [7, 5],
                    [7, 4],
                    [0, 2],
                    [0, 3],
                    [0, 1],
                    [0, 2],
                    [1, 3],
                    [1, 0],
                    [1, 2],
                    [1, 3],
                    [2, 0],
                    [2, 1],
                    [2, 3],
                    [2, 0],
                    [3, 1],
                    [3, 2],
                    [3, 0],
                    [3, 1],
                ]
            ),
            np.array(
                [
                    [1, 7],
                    [1, 3],
                    [3, 4],
                    [3, 7],
                    [4, 2],
                    [4, 4],
                    [0, 1],
                    [0, 2],
                    [2, 7],
                    [2, 2],
                    [5, 2],
                    [5, 4],
                    [7, 4],
                    [7, 1],
                    [0, 3],
                    [0, 5],
                    [7, 5],
                    [7, 1],
                    [5, 3],
                    [5, 1],
                    [4, 5],
                    [4, 4],
                    [7, 3],
                    [7, 0],
                    [7, 0],
                    [7, 2],
                    [7, 2],
                    [7, 7],
                    [0, 5],
                    [0, 7],
                    [1, 5],
                    [1, 2],
                    [2, 3],
                    [2, 7],
                    [3, 3],
                    [3, 0],
                ]
            ),
        )
    ],
)
def test_generate_all_examples(
    seed,
    fixtures_dir,
    n_negatives,
    window_size,
    shuffles,
    expected_positive,
    expected_negative,
):
    decks = json.load(Path(fixtures_dir, "read", "decks.json").open())

    actual_positive, actual_negative = generate_all_examples(
        decks, window_size, n_negatives, shuffles, multiprocessing=False
    )
    np.testing.assert_array_equal(actual_negative, expected_negative)
    np.testing.assert_array_equal(actual_positive, expected_positive)


@pytest.mark.parametrize(
    [
        "n_negatives",
        "window_size",
        "positive_array",
        "negative_array",
        "expected",
    ],
    [
        (
            2,
            5,
            np.array(
                [
                    [1, 3],
                    [1, 4],
                    [1, 3],
                    [1, 4],
                    [3, 4],
                    [3, 1],
                    [3, 4],
                    [3, 1],
                    [4, 1],
                    [4, 3],
                    [4, 1],
                    [4, 3],
                    [0, 2],
                    [0, 5],
                    [0, 2],
                    [0, 5],
                    [2, 5],
                    [2, 0],
                    [2, 5],
                    [2, 0],
                    [5, 0],
                    [5, 2],
                    [5, 0],
                    [5, 2],
                    [7, 0],
                    [7, 7],
                    [7, 0],
                    [7, 7],
                    [0, 7],
                    [0, 7],
                    [0, 7],
                    [0, 7],
                    [7, 7],
                    [7, 0],
                    [7, 7],
                    [7, 0],
                    [5, 7],
                    [5, 7],
                    [5, 4],
                    [5, 7],
                    [4, 7],
                    [4, 5],
                    [4, 7],
                    [4, 7],
                    [7, 5],
                    [7, 4],
                    [7, 7],
                    [7, 7],
                    [7, 4],
                    [7, 7],
                    [7, 7],
                    [7, 5],
                    [7, 7],
                    [7, 7],
                    [7, 5],
                    [7, 4],
                    [0, 2],
                    [0, 3],
                    [0, 1],
                    [0, 2],
                    [1, 3],
                    [1, 0],
                    [1, 2],
                    [1, 3],
                    [2, 0],
                    [2, 1],
                    [2, 3],
                    [2, 0],
                    [3, 1],
                    [3, 2],
                    [3, 0],
                    [3, 1],
                ]
            ),
            np.array(
                [
                    [1, 7],
                    [1, 3],
                    [3, 4],
                    [3, 7],
                    [4, 2],
                    [4, 4],
                    [0, 1],
                    [0, 2],
                    [2, 7],
                    [2, 2],
                    [5, 2],
                    [5, 4],
                    [7, 4],
                    [7, 1],
                    [0, 3],
                    [0, 5],
                    [7, 5],
                    [7, 1],
                    [5, 3],
                    [5, 1],
                    [4, 5],
                    [4, 4],
                    [7, 3],
                    [7, 0],
                    [7, 0],
                    [7, 2],
                    [7, 2],
                    [7, 7],
                    [0, 5],
                    [0, 7],
                    [1, 5],
                    [1, 2],
                    [2, 3],
                    [2, 7],
                    [3, 3],
                    [3, 0],
                ]
            ),
            [
                (
                    np.array([[1, 3], [1, 4], [1, 3], [1, 4]]),
                    np.array([[1, 7], [1, 3]]),
                ),
                (
                    np.array([[3, 4], [3, 1], [3, 4], [3, 1]]),
                    np.array([[3, 4], [3, 7]]),
                ),
                (
                    np.array([[4, 1], [4, 3], [4, 1], [4, 3]]),
                    np.array([[4, 2], [4, 4]]),
                ),
                (
                    np.array([[0, 2], [0, 5], [0, 2], [0, 5]]),
                    np.array([[0, 1], [0, 2]]),
                ),
                (
                    np.array([[2, 5], [2, 0], [2, 5], [2, 0]]),
                    np.array([[2, 7], [2, 2]]),
                ),
                (
                    np.array([[5, 0], [5, 2], [5, 0], [5, 2]]),
                    np.array([[5, 2], [5, 4]]),
                ),
                (
                    np.array([[7, 0], [7, 7], [7, 0], [7, 7]]),
                    np.array([[7, 4], [7, 1]]),
                ),
                (
                    np.array([[0, 7], [0, 7], [0, 7], [0, 7]]),
                    np.array([[0, 3], [0, 5]]),
                ),
                (
                    np.array([[7, 7], [7, 0], [7, 7], [7, 0]]),
                    np.array([[7, 5], [7, 1]]),
                ),
                (
                    np.array([[5, 7], [5, 7], [5, 4], [5, 7]]),
                    np.array([[5, 3], [5, 1]]),
                ),
                (
                    np.array([[4, 7], [4, 5], [4, 7], [4, 7]]),
                    np.array([[4, 5], [4, 4]]),
                ),
                (
                    np.array([[7, 5], [7, 4], [7, 7], [7, 7]]),
                    np.array([[7, 3], [7, 0]]),
                ),
                (
                    np.array([[7, 4], [7, 7], [7, 7], [7, 5]]),
                    np.array([[7, 0], [7, 2]]),
                ),
                (
                    np.array([[7, 7], [7, 7], [7, 5], [7, 4]]),
                    np.array([[7, 2], [7, 7]]),
                ),
                (
                    np.array([[0, 2], [0, 3], [0, 1], [0, 2]]),
                    np.array([[0, 5], [0, 7]]),
                ),
                (
                    np.array([[1, 3], [1, 0], [1, 2], [1, 3]]),
                    np.array([[1, 5], [1, 2]]),
                ),
                (
                    np.array([[2, 0], [2, 1], [2, 3], [2, 0]]),
                    np.array([[2, 3], [2, 7]]),
                ),
                (
                    np.array([[3, 1], [3, 2], [3, 0], [3, 1]]),
                    np.array([[3, 3], [3, 0]]),
                ),
            ],
        )
    ],
)
def test_generate_batches(
    n_negatives, window_size, positive_array, negative_array, expected
):

    batches = generate_batches(positive_array, negative_array, window_size, n_negatives)
    for (actual_pos, actual_neg), (expected_pos, expected_neg) in zip(
        batches, expected
    ):
        np.testing.assert_array_equal(actual_neg, expected_neg)
        np.testing.assert_array_equal(actual_pos, expected_pos)
